<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preparing data for RNN models • torchts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preparing data for RNN models">
<meta property="og:description" content="torchts">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">torchts</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-prepare-rnn.html">Preparing data for RNN models</a>
    </li>
    <li>
      <a href="../articles/missing-data.html">Handling missing data</a>
    </li>
    <li>
      <a href="../articles/prepare-tensor.html">Prepare tensor</a>
    </li>
    <li>
      <a href="../articles/univariate-time-series.html">Univariate Time Series</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data-prepare-rnn_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preparing data for RNN models</h1>
            
      
      
      <div class="hidden name"><code>data-prepare-rnn.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dołączanie pakietu: 'dplyr'</span>
<span class="co">#&gt; Następujące obiekty zostały zakryte z 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; Następujące obiekty zostały zakryte z 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">torchts</span><span class="op">)</span></pre></div>
<div id="downloading-m5-challenge-data-set" class="section level2">
<h2 class="hasAnchor">
<a href="#downloading-m5-challenge-data-set" class="anchor"></a>Downloading M5 challenge data set</h2>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># Downloading Walmart data</span>
<span class="co"># Walmart data</span></pre></div>
<p>The M5 challenge data set is quite large, so it will be good to reduce the input data frame.</p>
</div>
<div id="data-wrangling" class="section level2">
<h2 class="hasAnchor">
<a href="#data-wrangling" class="anchor"></a>Data Wrangling</h2>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">walmart_foods_ca1_prepared</span> <span class="op">&lt;-</span>
  <span class="fu">fst</span><span class="fu">::</span><span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html">read_fst</a></span><span class="op">(</span><span class="st">"../data/walmart/walmart_foods_ca1_prepared.fst"</span><span class="op">)</span>

<span class="va">experiment_data</span> <span class="op">&lt;-</span>
  <span class="va">walmart_foods_ca1_prepared</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dept_id</span> <span class="op">==</span> <span class="st">"FOODS_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">snap_TX</span>, <span class="op">-</span><span class="va">snap_WI</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">d</span>, <span class="va">wm_yr_wk</span>, <span class="va">id</span>, <span class="va">dept_id</span>, <span class="va">value</span>,
         <span class="va">date</span>, <span class="va">wday</span>, <span class="va">month</span>, <span class="va">year</span>, <span class="va">event_name_1</span>,
         <span class="va">event_type_1</span>, <span class="va">event_name_2</span>, <span class="va">event_type_2</span>, <span class="va">snap_CA</span>,
         <span class="va">sell_price</span><span class="op">)</span>

<span class="va">experiment_data</span> <span class="op">&lt;-</span>
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.factor</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span>

<span class="va">experiment_data</span> <span class="op">&lt;-</span>
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>,<span class="va">value</span>, <span class="va">wday</span>,
         <span class="va">month</span>, <span class="va">year</span>, <span class="va">snap_CA</span>, <span class="va">sell_price</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span><span class="op">)</span></pre></div>
<p>We assume that we want to create a <strong>three-dimensional tensor</strong>, the each dimension of presents:</p>
<ul>
<li><strong>item</strong></li>
<li><strong>time steps</strong></li>
<li><strong>features</strong></li>
</ul>
<p>This assumption makes us to keep the data “complete”, i.e. every single item time series has to have the same <strong>length</strong>. The first dimension is “free”, and the completeness of the last dimension is guaranteed by the data.frame structure itself (each row has the same number of columns).</p>
<p>For simplicity’s sake, we can just select a subset of items with the same series length as well as the first and last date. In such case, we’ll be sure that our data are properly aligned in the tensor. Later, in a separate vignette, we’ll dive into a set of methods, how to handle missing/non-aligned multiple time series when training a deep learning model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">data_summary</span> <span class="op">&lt;-</span> 
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">item_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      len <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
      first_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,
      last_date  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">len</span>, <span class="va">first_date</span>, <span class="va">last_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
      n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
      item_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">item_id</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'len', 'first_date'. You can override using the `.groups` argument.</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_summary</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt; # Groups:   len, first_date [6]</span>
<span class="co">#&gt;     len first_date last_date      n item_id    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;int&gt; &lt;list&gt;     </span>
<span class="co">#&gt; 1  1913 2011-01-29 2016-04-24   101 &lt;chr [101]&gt;</span>
<span class="co">#&gt; 2  1031 2013-06-29 2016-04-24     9 &lt;chr [9]&gt;  </span>
<span class="co">#&gt; 3  1731 2011-07-30 2016-04-24     9 &lt;chr [9]&gt;  </span>
<span class="co">#&gt; 4  1514 2012-03-03 2016-04-24     8 &lt;chr [8]&gt;  </span>
<span class="co">#&gt; 5  1906 2011-02-05 2016-04-24     6 &lt;chr [6]&gt;  </span>
<span class="co">#&gt; 6  1164 2013-02-16 2016-04-24     5 &lt;chr [5]&gt;</span></pre></div>
<p>We choose a subset consisting of 101 products - each product has:</p>
<ul>
<li>lenght: 1913 days</li>
<li>first_date: 2011-01-29</li>
<li>last_date: 2016-04-24</li>
</ul>
<p>If we check the tme difference between these two dates</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">'2016-04-24'</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">'2011-01-29'</span><span class="op">)</span>
<span class="co">#&gt; Time difference of 1912 days</span></pre></div>
<p>we’ll can see that there are no gaps in the subset we’ve just selected, so we have not to do any additional filtering or aligning.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">selected_items</span> <span class="op">&lt;-</span> 
  <span class="va">data_summary</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">item_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">experiment_data</span> <span class="op">&lt;-</span> 
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">%in%</span> <span class="va">selected_items</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">experiment_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 193213</span></pre></div>
<p>Let’s take a look on the data we’ve already prepared.</p>
</div>
<div id="transorming-to-tensor" class="section level2">
<h2 class="hasAnchor">
<a href="#transorming-to-tensor" class="anchor"></a>Transorming to tensor</h2>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">experiment_data</span><span class="op">)</span>
<span class="co">#&gt;       item_id       date value wday month year snap_CA sell_price</span>
<span class="co">#&gt; 1 FOODS_1_001 2011-01-29     3    1     1 2011       0          2</span>
<span class="co">#&gt; 2 FOODS_1_001 2011-01-30     0    2     1 2011       0          2</span>
<span class="co">#&gt; 3 FOODS_1_001 2011-01-31     0    3     1 2011       0          2</span>
<span class="co">#&gt; 4 FOODS_1_001 2011-02-01     1    4     2 2011       1          2</span>
<span class="co">#&gt; 5 FOODS_1_001 2011-02-02     4    5     2 2011       1          2</span>
<span class="co">#&gt; 6 FOODS_1_001 2011-02-03     2    6     2 2011       1          2</span></pre></div>
<p>The first column, <code>item_id</code>, describes the item we already the item and the second one (<code>date</code>) - a current time step. These two columns will be used to create a data “fold”, i.e. form a 3D tensor. As we mentioned above, the completness of the time moments is crucial to obtain a proper result from this transformation.</p>
<p>If it comes, to the rest of columns:</p>
<ul>
<li>
<code>value</code> is a target we want to predict</li>
<li>
<code>wday</code> is a categorical variable</li>
<li>
<code>month</code> is a categorical variable</li>
<li>
<code>year</code> <em>can</em> be treated as categorical, but in this case we may remove this variable and introduce a counter instead</li>
<li>
<code>snap_CA</code> is a categorical variable</li>
<li>
<code>sell_price</code> is a real-valued variable</li>
</ul>
<p>Summarizing, we have three categorical variables, which should be represented in some way. The most efficient manner to represent categorical variables in neural network is <strong>embedding</strong> layer.<br>
In fact, it works similar to a <strong>linear</strong> (<strong>dense</strong>) layer. The difference is that instead of performing resource-consuming dot product between weight matrix and the input one-hot encoded sparse matrix, we just use an index to select “right” row from the weight matrix.</p>
<p>Because of this index-based nature of embedding, we need to transform all the categorical features to 1-n to range.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">experiment_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">wday</span>, <span class="va">month</span>, <span class="va">snap_CA</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">unique</span><span class="op">)</span>
<span class="co">#&gt; $wday</span>
<span class="co">#&gt; [1] 1 2 3 4 5 6 7</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $month</span>
<span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10 11 12</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $snap_CA</span>
<span class="co">#&gt; [1] 0 1</span></pre></div>
<p>In this case the only variable we need to recode is snap_Ca.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">experiment_data</span> <span class="op">&lt;-</span> 
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>snap_CA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">snap_CA</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">d_size</span> <span class="op">&lt;-</span>
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">wday</span>, <span class="va">month</span>,
    <span class="va">snap_CA</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dict_size.html">dict_size</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p>Let’s transform tabular data into tensor. A good way to do it is to use a convenient <code>as_tensor</code> function. The first argument of the function (described as <code>.data</code>) is a <code>data.frame</code> object, which we want to transform into a <code>torch_tensor</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">product_data</span> <span class="op">&lt;-</span> 
  <span class="va">experiment_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>shifted_value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span>

<span class="va">train_data</span> <span class="op">&lt;-</span> 
  <span class="va">product_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">-</span> <span class="fl">50</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">test_data</span> <span class="op">&lt;-</span> 
  <span class="va">product_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>

<span class="co"># Train tensors</span>
<span class="va">X_train_tensor_cat</span> <span class="op">&lt;-</span>
  <span class="va">train_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">item_id</span>, <span class="va">date</span>, <span class="va">wday</span>, <span class="va">month</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">X_train_tensor_rest</span> <span class="op">&lt;-</span> 
  <span class="va">train_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">item_id</span>, <span class="va">date</span>, <span class="va">shifted_value</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># print(class(X_tensor_cat))</span>
<span class="co"># print(X_tensor_cat$shape)</span>

<span class="va">y_tensor</span> <span class="op">&lt;-</span>
  <span class="va">train_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html">torch_float</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Test data</span>
<span class="va">X_test_tensor_cat</span> <span class="op">&lt;-</span>
  <span class="va">test_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">item_id</span>, <span class="va">date</span>, <span class="va">wday</span>, <span class="va">month</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">X_test_tensor_rest</span> <span class="op">&lt;-</span> 
  <span class="va">test_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">item_id</span>, <span class="va">date</span>, <span class="va">shifted_value</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">item_id</span> <span class="op">==</span> <span class="st">"FOODS_1_001"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, dtype <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_dtype.html">torch_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<div id="embedding-for-categorical-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#embedding-for-categorical-variables" class="anchor"></a>Embedding for categorical variables</h3>
<p>First, let’s create <strong>a multiple embedding module</strong>. A causal <strong>embedding module</strong> is a simple, but memory efficient operation, which allows us to transform a sequence of categorical features into sequence of embedding vectors.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">

<span class="co"># recurrent_network &lt;- </span>
<span class="co">#   nn_gru(</span>
<span class="co">#     input_size  = 1,</span>
<span class="co">#     hidden_size = 3,</span>
<span class="co">#     num_layers  = 1</span>
<span class="co">#   )</span>


<span class="co"># embedding &lt;- </span>
<span class="co">#   nn_multi_embedding(</span>
<span class="co">#     num_embeddings = d_size,</span>
<span class="co">#     embedding_dim  = rep(3, length(d_size))</span>
<span class="co">#   )</span>
<span class="co"># </span>
<span class="co"># X_tensor_cat_processed &lt;-  embedding(X_tensor_cat)</span></pre></div>
</div>
<div id="feature-concatenation" class="section level3">
<h3 class="hasAnchor">
<a href="#feature-concatenation" class="anchor"></a>Feature concatenation</h3>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co"># X_transformed &lt;- torch_cat(</span>
<span class="co">#   list(X_tensor_rest, X_tensor_cat_processed), dim = -1</span>
<span class="co"># )</span></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="co"># recurrent_layer &lt;- nn_gru(12, 48)</span>
<span class="co"># out &lt;- recurrent_layer(X_transformed)</span>
<span class="co"># out </span>
<span class="co"># </span>
<span class="co"># nn_linear(48, 1)(out[[1]])</span>

<span class="co"># simple_rnn &lt;- nn_module(</span>
<span class="co">#   "nn_simple_rnn",</span>
<span class="co">#   initialize = function(num_embeddings, embedding_dim, rnn_input_size, output_size){</span>
<span class="co">#     self$embedding &lt;- nn_multi_embedding(num_embeddings, embedding_dim)</span>
<span class="co">#     self$recurrent_layer &lt;- nn_gru(rnn_input_size, output_size)</span>
<span class="co">#     self$linear &lt;- nn_linear(output_size, 1)</span>
<span class="co">#   },</span>
<span class="co">#   forward = function(input_cat, input_rest){</span>
<span class="co">#     X_tensor_cat_processed &lt;- self$embedding(X_tensor_cat)</span>
<span class="co">#     X_transformed &lt;- torch_cat(</span>
<span class="co">#         list(X_tensor_rest, X_tensor_cat_processed), dim = -1</span>
<span class="co">#     )</span>
<span class="co">#     out &lt;- self$recurrent_layer(X_transformed)</span>
<span class="co">#     nnf_relu(self$linear(nnf_relu(out[[1]])))</span>
<span class="co">#   }</span>
<span class="co"># )</span>
<span class="co"># </span>
<span class="co"># simple_rnn_instance &lt;- simple_rnn(d_size, rep(3, length(d_size)), 12, 48)</span>
<span class="co"># simple_rnn_instance(X_tensor_cat, X_tensor_rest)</span>

<span class="co"># recurrent_network &lt;- model_recurrent(</span>
<span class="co">#   fwd_numeric_input = 1,</span>
<span class="co">#   fwd_input_size    = 3,</span>
<span class="co">#   fwd_output_size   = 8,</span>
<span class="co">#   num_embeddings    = d_size,</span>
<span class="co">#   embedding_dim     = round(d_size ** 0.25),</span>
<span class="co">#   </span>
<span class="co"># )</span></pre></div>
</div>
<div id="training-recurrent-neural-network" class="section level3">
<h3 class="hasAnchor">
<a href="#training-recurrent-neural-network" class="anchor"></a>Training Recurrent Neural Network</h3>
<div class="sourceCode" id="cb15"><pre class="downlit">

<span class="co"># debugonce(recurrent_network$forward)</span>
<span class="co"># </span>
<span class="co"># recurrent_network$forward(X_train_tensor_cat, X_train_tensor_rest)</span>
<span class="co"># </span>
<span class="co"># optim &lt;- optim_adagrad(recurrent_network$parameters, lr = 0.01)</span>
<span class="co"># </span>
<span class="co"># for (i in 1:100) {</span>
<span class="co">#   recurrent_network$zero_grad()</span>
<span class="co">#   fcast &lt;- recurrent_network(X_train_tensor_cat, X_train_tensor_rest)</span>
<span class="co">#   loss  &lt;- nnf_mse_loss(fcast, y_tensor)</span>
<span class="co">#   loss$backward()</span>
<span class="co">#   print(loss)</span>
<span class="co">#   optim$step()</span>
<span class="co"># }</span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># trial(optim_adagrad(lr = 0.1))</span></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://krzjoa.github.io">Krzysztof Joachimiak</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
