<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preparing data for recurrent models • torchts</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preparing data for recurrent models">
<meta property="og:description" content="torchts">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">torchts</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-prepare-rnn.html">Preparing data for recurrent models</a>
    </li>
    <li>
      <a href="../articles/naming-convention.html">Naming convention</a>
    </li>
    <li>
      <a href="../articles/parsnip-api.html">parsnip API</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/krzjoa/torchts/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data-prepare-rnn_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preparing data for recurrent models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/krzjoa/torchts/blob/master/vignettes/data-prepare-rnn.Rmd"><code>vignettes/data-prepare-rnn.Rmd</code></a></small>
      <div class="hidden name"><code>data-prepare-rnn.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs">torch</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/krzjoa/torchts">torchts</a></span><span class="op">)</span></pre></div>
<div id="look-at-the-tiny_m5" class="section level2">
<h2 class="hasAnchor">
<a href="#look-at-the-tiny_m5" class="anchor"></a>Look at the <code>tiny_m5</code>
</h2>
<p>If you practice time series modeling, you probably may hear about the M5 challenge by <a href="https://en.wikipedia.org/wiki/Spyros_Makridakis">Spyros Makridakis</a>, hosted on Kaggle. It’s an excellent data set, if we want to play with demand time series. The whole dataset is really large, so we rather can use a subset to demonstrate, how to work with such data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">tiny_m5</span><span class="op">$</span><span class="va">store_id</span><span class="op">)</span>
<span class="co">#&gt;  [1] "CA_1" "CA_2" "CA_3" "CA_4" "TX_1" "TX_2" "TX_3" "WI_1" "WI_2" "WI_3"</span>

<span class="va">ca_1_data</span> <span class="op">&lt;-</span>
  <span class="va">tiny_m5</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">store_id</span> <span class="op">==</span> <span class="st">"CA_1"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">store_id</span>, <span class="va">date</span>, <span class="va">value</span>, <span class="va">wday</span>,
         <span class="va">month</span>, <span class="va">year</span>, <span class="va">snap</span>, <span class="va">sell_price</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span><span class="op">)</span>

<span class="va">ca_1_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">item_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 28 × 2</span>
<span class="co">#&gt;    item_id         n</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;int&gt;</span>
<span class="co">#&gt;  1 FOODS_1_033  1913</span>
<span class="co">#&gt;  2 FOODS_1_046  1913</span>
<span class="co">#&gt;  3 FOODS_1_057  1913</span>
<span class="co">#&gt;  4 FOODS_1_218  1913</span>
<span class="co">#&gt;  5 FOODS_2_096  1913</span>
<span class="co">#&gt;  6 FOODS_2_181  1913</span>
<span class="co">#&gt;  7 FOODS_2_352  1913</span>
<span class="co">#&gt;  8 FOODS_2_360  1913</span>
<span class="co">#&gt;  9 FOODS_3_080  1913</span>
<span class="co">#&gt; 10 FOODS_3_377  1913</span>
<span class="co">#&gt; # … with 18 more rows</span>

<span class="fu">skimr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/skimr/reference/skim.html">skim</a></span><span class="op">(</span><span class="va">ca_1_data</span><span class="op">)</span></pre></div>
<table class="table">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">ca_1_data</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">53564</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">9</td>
</tr>
<tr class="even">
<td align="left">Key</td>
<td align="left">NULL</td>
</tr>
<tr class="odd">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">character</td>
<td align="left">2</td>
</tr>
<tr class="even">
<td align="left">Date</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">6</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table">
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">item_id</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">11</td>
<td align="right">15</td>
<td align="right">0</td>
<td align="right">28</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">store_id</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table class="table">
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">min</th>
<th align="left">max</th>
<th align="left">median</th>
<th align="right">n_unique</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">date</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2011-01-29</td>
<td align="left">2016-04-24</td>
<td align="left">2013-09-11</td>
<td align="right">1913</td>
</tr></tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table">
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">value</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">5.52</td>
<td align="right">10.90</td>
<td align="right">0.0</td>
<td align="right">0.00</td>
<td align="right">1.00</td>
<td align="right">6.00</td>
<td align="right">133.00</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">wday</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">4.00</td>
<td align="right">2.00</td>
<td align="right">1.0</td>
<td align="right">2.00</td>
<td align="right">4.00</td>
<td align="right">6.00</td>
<td align="right">7.00</td>
<td align="left">▇▃▃▃▇</td>
</tr>
<tr class="odd">
<td align="left">month</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">6.36</td>
<td align="right">3.46</td>
<td align="right">1.0</td>
<td align="right">3.00</td>
<td align="right">6.00</td>
<td align="right">9.00</td>
<td align="right">12.00</td>
<td align="left">▇▅▅▅▇</td>
</tr>
<tr class="even">
<td align="left">year</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2013.21</td>
<td align="right">1.53</td>
<td align="right">2011.0</td>
<td align="right">2012.00</td>
<td align="right">2013.00</td>
<td align="right">2015.00</td>
<td align="right">2016.00</td>
<td align="left">▇▅▅▅▁</td>
</tr>
<tr class="odd">
<td align="left">snap</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.33</td>
<td align="right">0.47</td>
<td align="right">0.0</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">1.00</td>
<td align="right">1.00</td>
<td align="left">▇▁▁▁▃</td>
</tr>
<tr class="even">
<td align="left">sell_price</td>
<td align="right">7693</td>
<td align="right">0.86</td>
<td align="right">3.33</td>
<td align="right">3.34</td>
<td align="right">0.5</td>
<td align="right">0.97</td>
<td align="right">1.68</td>
<td align="right">4.97</td>
<td align="right">11.54</td>
<td align="left">▇▁▁▁▂</td>
</tr>
</tbody>
</table>
<p>For deep learning models for time series, we’d typically like to create a <strong>three-dimensional tensor</strong>. In the analyzed case, the each dimension may represent:</p>
<ul>
<li><strong>item</strong></li>
<li><strong>time steps</strong></li>
<li><strong>features</strong></li>
</ul>
<p>The first dimension is “free” - we can add an arbitrary number of items. When it comes to the second one, they length may vary as well. However, for convenience, we’ll keep same-length time series. Otherwise, we’d have to use masking or split the dataset into multiple tensors. The last dimension size is guaranteed by the data.frame structure itself (each row has the same number of columns).</p>
<p>As we can observed in the output of <code>skim</code> function, there are time series with missing data.</p>
<p>As mentioned before, for simplicity’s sake, we can just select a subset of items with the same series length as well as the first and last date. In such case, we’ll be sure that our data are properly aligned in the tensor. Later, in a separate vignette, we’ll dive into a set of methods, how to handle missing/non-aligned multiple time series when training a deep learning model.</p>
</div>
<div id="as_tensor" class="section level2">
<h2 class="hasAnchor">
<a href="#as_tensor" class="anchor"></a>as_tensor</h2>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ca_1_data</span><span class="op">)</span>
<span class="co">#&gt;        item_id store_id       date value wday month year snap sell_price</span>
<span class="co">#&gt; 1: FOODS_1_033     CA_1 2011-01-29     0    1     1 2011    0         NA</span>
<span class="co">#&gt; 2: FOODS_1_033     CA_1 2011-01-30     0    2     1 2011    0         NA</span>
<span class="co">#&gt; 3: FOODS_1_033     CA_1 2011-01-31     0    3     1 2011    0         NA</span>
<span class="co">#&gt; 4: FOODS_1_033     CA_1 2011-02-01     0    4     2 2011    1         NA</span>
<span class="co">#&gt; 5: FOODS_1_033     CA_1 2011-02-02     0    5     2 2011    1         NA</span>
<span class="co">#&gt; 6: FOODS_1_033     CA_1 2011-02-03     0    6     2 2011    1         NA</span></pre></div>
<p>The first column, <code>item_id</code>, describes the item we already the item and the second one (<code>date</code>) - a current time step. These two columns will be used to create a data “fold”, i.e. form a 3D tensor. As we mentioned above, the completness of the time moments is crucial to obtain a proper result from this transformation.</p>
<p>If it comes, to the rest of columns:</p>
<ul>
<li>
<code>value</code> is a target we want to predict</li>
<li>
<code>wday</code> is a categorical variable</li>
<li>
<code>month</code> is a categorical variable</li>
<li>
<code>year</code> <em>can</em> be treated as categorical, but in this case we may remove this variable and introduce a counter instead</li>
<li>
<code>snap</code> is a categorical variable</li>
<li>
<code>sell_price</code> is a real-valued variable</li>
</ul>
<p>Summarizing, we have three categorical variables, which should be represented in some way. The most efficient manner to represent categorical variables in neural network is <strong>embedding</strong> layer.<br>
In fact, it works similar to a <strong>linear</strong> (<strong>dense</strong>) layer. The difference is that instead of performing resource-consuming dot product between weight matrix and the input one-hot encoded sparse matrix, we just use an index to select “right” row from the weight matrix.</p>
<p>Let’s transform tabular data into tensor. A good way to do it is to use a convenient <code>as_tensor</code> function. The first argument of the function (described as <code>.data</code>) is a <code>data.frame</code> object, which we want to transform into a <code>torch_tensor</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">ca_1_data</span><span class="op">)</span>
<span class="co">#&gt; [1] "item_id"    "store_id"   "date"       "value"      "wday"      </span>
<span class="co">#&gt; [6] "month"      "year"       "snap"       "sell_price"</span></pre></div>
<p>First, we’ll select only integer <code>item_id</code>, <code>date</code> and integer variables.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">ca_1</span> <span class="op">&lt;-</span> 
  <span class="va">ca_1_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, <span class="va">wday</span>, <span class="va">month</span>, <span class="va">year</span>, <span class="va">snap</span><span class="op">)</span>

<span class="va">ca_1_tensor</span> <span class="op">&lt;-</span> 
  <span class="va">ca_1</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ca_1_tensor</span><span class="op">)</span>
<span class="co">#&gt; [1]   28 1913    4</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">ca_1_tensor</span><span class="op">)</span>
<span class="co">#&gt; [1] "torch_tensor" "R7"</span>

<span class="va">ca_1_tensor</span> <span class="op">&lt;-</span> 
  <span class="va">ca_1_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span>, <span class="va">wday</span>, <span class="va">month</span>, <span class="va">year</span>, <span class="va">snap</span>, <span class="va">sell_price</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.integer</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/as_tensor.html">as_tensor</a></span><span class="op">(</span><span class="va">item_id</span>, <span class="va">date</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ca_1_tensor</span><span class="op">)</span>
<span class="co">#&gt; [1]   28 1913    5</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">ca_1_tensor</span><span class="op">)</span>
<span class="co">#&gt; [1] "torch_tensor" "R7"</span></pre></div>
</div>
<div id="as_ts_dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#as_ts_dataset" class="anchor"></a>as_ts_dataset</h2>
<p>To speed up <code>torch</code> models developments, <code>torchts</code> package provides easy-to-use <code>as_ts_dataset</code> method, which is a shortcut to create a <code>torch</code> dataset from a <code>data.frame</code>. For now keys like <code>item_id</code> are not supported - this feature will be implemented in the near future. We’ll present this function using <code>weather_pl</code> dataset.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span>

<span class="va">suwalki_temp</span> <span class="op">&lt;-</span>
  <span class="va">weather_pl</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">station</span> <span class="op">==</span> <span class="st">"SWK"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, temp <span class="op">=</span> <span class="va">tmax_daily</span><span class="op">)</span>

<span class="co">#' # Splitting on training and test</span>
<span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">initial_time_split</a></span><span class="op">(</span><span class="va">suwalki_temp</span><span class="op">)</span>

<span class="va">train_ds</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/as_ts_dataset.html">as_ts_dataset</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">date</span>, timesteps <span class="op">=</span> <span class="fl">20</span>, horizon <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">train_ds</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt; -1.1453</span>
<span class="co">#&gt; -1.2624</span>
<span class="co">#&gt; -1.0867</span>
<span class="co">#&gt; -1.0282</span>
<span class="co">#&gt; -1.0672</span>
<span class="co">#&gt; -0.8330</span>
<span class="co">#&gt; -0.7354</span>
<span class="co">#&gt; -1.0282</span>
<span class="co">#&gt; -1.0087</span>
<span class="co">#&gt; -0.9891</span>
<span class="co">#&gt; -1.0477</span>
<span class="co">#&gt; -1.1746</span>
<span class="co">#&gt; -1.3893</span>
<span class="co">#&gt; -0.9891</span>
<span class="co">#&gt; -0.9794</span>
<span class="co">#&gt; -1.0965</span>
<span class="co">#&gt; -1.2527</span>
<span class="co">#&gt; -1.4186</span>
<span class="co">#&gt; -1.4869</span>
<span class="co">#&gt; -1.4088</span>
<span class="co">#&gt; [ CPUFloatType{20,1} ]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt; -3.6000</span>
<span class="co">#&gt; [ CPUFloatType{1} ]</span></pre></div>
</div>
<div id="as_ts_dataloader" class="section level2">
<h2 class="hasAnchor">
<a href="#as_ts_dataloader" class="anchor"></a>as_ts_dataloader</h2>
<p>The quickest shortcut to get needed data-provding object is to call <code>as_ts_dataloader</code> function. It can be used as follows.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">train_dl</span> <span class="op">&lt;-</span>
   <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="../reference/as_ts_dataloader.html">as_ts_dataloader</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">date</span>, timesteps <span class="op">=</span> <span class="fl">20</span>, horizon <span class="op">=</span> <span class="fl">1</span>, batch_size <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>

<span class="va">train_dl</span>
<span class="co">#&gt; &lt;dataloader&gt;</span>
<span class="co">#&gt;   Public:</span>
<span class="co">#&gt;     .auto_collation: active binding</span>
<span class="co">#&gt;     .dataset_kind: map</span>
<span class="co">#&gt;     .has_getbatch: FALSE</span>
<span class="co">#&gt;     .index_sampler: active binding</span>
<span class="co">#&gt;     .iter: function () </span>
<span class="co">#&gt;     .length: function () </span>
<span class="co">#&gt;     batch_sampler: utils_sampler_batch, utils_sampler, R6</span>
<span class="co">#&gt;     batch_size: 32</span>
<span class="co">#&gt;     clone: function (deep = FALSE) </span>
<span class="co">#&gt;     collate_fn: function (batch) </span>
<span class="co">#&gt;     dataset: ts_dataset, dataset, R6</span>
<span class="co">#&gt;     drop_last: FALSE</span>
<span class="co">#&gt;     generator: NULL</span>
<span class="co">#&gt;     initialize: function (dataset, batch_size = 1, shuffle = FALSE, sampler = NULL, </span>
<span class="co">#&gt;     multiprocessing_context: NULL</span>
<span class="co">#&gt;     num_workers: 0</span>
<span class="co">#&gt;     pin_memory: FALSE</span>
<span class="co">#&gt;     sampler: utils_sampler_sequential, utils_sampler, R6</span>
<span class="co">#&gt;     timeout: -1</span>
<span class="co">#&gt;     worker_globals: NULL</span>
<span class="co">#&gt;     worker_init_fn: NULL</span>
<span class="co">#&gt;     worker_packages: NULL</span>

<span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader_next.html">dataloader_next</a></span><span class="op">(</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/dataloader_make_iter.html">dataloader_make_iter</a></span><span class="op">(</span><span class="va">train_dl</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt; (1,.,.) = </span>
<span class="co">#&gt;  -1.1453</span>
<span class="co">#&gt;  -1.2624</span>
<span class="co">#&gt;  -1.0867</span>
<span class="co">#&gt;  -1.0282</span>
<span class="co">#&gt;  -1.0672</span>
<span class="co">#&gt;  -0.8330</span>
<span class="co">#&gt;  -0.7354</span>
<span class="co">#&gt;  -1.0282</span>
<span class="co">#&gt;  -1.0087</span>
<span class="co">#&gt;  -0.9891</span>
<span class="co">#&gt;  -1.0477</span>
<span class="co">#&gt;  -1.1746</span>
<span class="co">#&gt;  -1.3893</span>
<span class="co">#&gt;  -0.9891</span>
<span class="co">#&gt;  -0.9794</span>
<span class="co">#&gt;  -1.0965</span>
<span class="co">#&gt;  -1.2527</span>
<span class="co">#&gt;  -1.4186</span>
<span class="co">#&gt;  -1.4869</span>
<span class="co">#&gt;  -1.4088</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (2,.,.) = </span>
<span class="co">#&gt;  -1.2624</span>
<span class="co">#&gt;  -1.0867</span>
<span class="co">#&gt;  -1.0282</span>
<span class="co">#&gt;  -1.0672</span>
<span class="co">#&gt;  -0.8330</span>
<span class="co">#&gt;  -0.7354</span>
<span class="co">#&gt;  -1.0282</span>
<span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span>
<span class="co">#&gt; [ CPUFloatType{32,20,1} ]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; torch_tensor</span>
<span class="co">#&gt; -3.6000</span>
<span class="co">#&gt; -5.0000</span>
<span class="co">#&gt; -4.2000</span>
<span class="co">#&gt; -2.5000</span>
<span class="co">#&gt;  0.6000</span>
<span class="co">#&gt;  1.5000</span>
<span class="co">#&gt;  1.5000</span>
<span class="co">#&gt;  1.0000</span>
<span class="co">#&gt;  2.0000</span>
<span class="co">#&gt;  1.2000</span>
<span class="co">#&gt;  0.2000</span>
<span class="co">#&gt; -2.2000</span>
<span class="co">#&gt; -5.1000</span>
<span class="co">#&gt; -6.7000</span>
<span class="co">#&gt; -12.1000</span>
<span class="co">#&gt; -6.7000</span>
<span class="co">#&gt;  2.6000</span>
<span class="co">#&gt;  4.9000</span>
<span class="co">#&gt;  5.0000</span>
<span class="co">#&gt;  8.8000</span>
<span class="co">#&gt;  3.9000</span>
<span class="co">#&gt;  2.1000</span>
<span class="co">#&gt;  5.3000</span>
<span class="co">#&gt;  5.5000</span>
<span class="co">#&gt;  2.4000</span>
<span class="co">#&gt;  2.1000</span>
<span class="co">#&gt;  3.8000</span>
<span class="co">#&gt;  2.0000</span>
<span class="co">#&gt;  0.3000</span>
<span class="co">#&gt;  0.1000</span>
<span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span>
<span class="co">#&gt; [ CPUFloatType{32,1} ]</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://krzjoa.github.io">Krzysztof Joachimiak</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
